/* eslint-disable @typescript-eslint/camelcase */
import { expect } from "chai";
import { describe, it, afterEach } from "mocha";
import sinon from "sinon";
import moxios from "moxios";
import { KoreaDumper } from "./KoreaDumper";
import { checkAndNotify } from "../../testing/checkAndNotify";

describe("KoreaDumper", () => {
  afterEach(() => sinon.restore());

  it("KoreaDumper should be created successfully", () => {
    // eslint-disable-next-line no-new
    const instance = new KoreaDumper();
    expect(instance).to.be.instanceOf(KoreaDumper);
  });

  describe("getFullDump titleId", () => {
    describe("the titleId attribute", () => {
      it("should be parsed from attribute 22 when available", (done) => {
        const dumpSpy = sinon.spy();
        const promise = new KoreaDumper().getFullDump().then(dumpSpy).catch(done);

        moxios.wait(async () => {
          const requestResponse = moxios.requests.mostRecent();
          requestResponse.respondWith({
            headers: {
              "Content-Type": "text/html; charset=UTF-8",
            },
            responseText: JSON.stringify([
              {
                "0": "517",
                "1": "switch",
                "2": "2020-01-30 17:00:00",
                "3": "1",
                "4": "trialsofmana",
                "5": null,
                "6": "성검전설3 TRIALS of MANA (한국어판)",
                "7": "0",
                "8": "2020-04-24",
                "9": null,
                "10": null,
                "11": "1",
                "12": "SQUARE ENIX",
                "13": "0",
                "14": "0",
                "15": null,
                "16": null,
                "17": "0",
                "18": "517.jpg",
                "19": "517.jpg",
                "20": "/home/product/admin/private/sw/switch/517/",
                "21": "1",
                "22": "https://store.nintendo.co.kr/70010000025168",
                "23": null,
                "24": null,
                "25": null,
                "26": null,
                "27": null,
                "28": null,
                "29": null,
                "30": null,
                "31": null,
                "32": null,
                "33": null,
                "34": null,
                "35": null,
                "36": null,
                "37": null,
                "38": "0",
                "39": "0",
                "40": "0",
                "41": "2020-03-26 14:48:30",
                "42": null,
                "43": "",
                "44": "aqua8219",
                "45": "OM",
                "46": null,
                "47": null,
                "48": "517",
                "49": "SQUARE ENIX",
                "50": "new",
                "51": "533",
                "52": "1",
                "53": "2020.04.24",
                "54": "Nintendo Switch",
                "55": "0",
                "56": null,
                no: "517",
                sw_gubun: "switch",
                open_schdl: "2020-01-30 17:00:00",
                show_list: "1",
                sw_code: "trialsofmana",
                sw_series: null,
                sw_name: "성검전설3 TRIALS of MANA (한국어판)",
                rls_date_gubun: "0",
                rls_date_cal: "2020-04-24",
                rls_date_sel_y: null,
                rls_date_sel_m: null,
                maker_gubun: "1",
                maker_name: "SQUARE ENIX",
                rls_gubun: "0",
                lang_gubun: "0",
                nrml_price: null,
                rdcd_price: null,
                evnt_list: "0",
                list_bnr_file_name: "517.jpg",
                list_bnr_origin_name: "517.jpg",
                list_bnr_file_path: "/home/product/admin/private/sw/switch/517/",
                link_gubun: "1",
                link: "https://store.nintendo.co.kr/70010000025168",
                sw_contents: null,
                head_copy: null,
                head_copy_color: null,
                bg_color: null,
                etc_color: null,
                btn_color: null,
                btn_txt_color: null,
                main_file_name: null,
                main_origin_name: null,
                main_file_path: null,
                sw_etc_contents: null,
                copyright: null,
                icon_file_name: null,
                icon_origin_name: null,
                icon_file_path: null,
                show_yn: "0",
                accept_yn: "0",
                del_yn: "0",
                reg_date: "2020-03-26 14:48:30",
                sw_genre: null,
                exper_gubun: "",
                auth: "aqua8219",
                rating: "OM",
                attach_text: null,
                search_tag: null,
                maker_gubun_ko: "SQUARE ENIX",
                new: "new",
                list_num: "533",
                dwn_flag: "1",
                rls_date_cal_fmt: "2020.04.24",
                sw_gubun_ko: "Nintendo Switch",
                qr_count: "0",
                detail: null,
              },
            ]),
          });

          await promise;

          const data = dumpSpy.lastCall.lastArg.pop();
          checkAndNotify(() => expect(data.nsuid).to.eq(70010000025168), done);
        });
      });

      it("should be parsed from attribute link when link is available and 22 is not", (done) => {
        const dumpSpy = sinon.spy();
        const promise = new KoreaDumper().getFullDump().then(dumpSpy).catch(done);

        moxios.wait(async () => {
          const requestResponse = moxios.requests.mostRecent();
          requestResponse.respondWith({
            headers: {
              "Content-Type": "text/html; charset=UTF-8",
            },
            responseText: JSON.stringify([
              {
                "0": "517",
                "1": "switch",
                "2": "2020-01-30 17:00:00",
                "3": "1",
                "4": "trialsofmana",
                "5": null,
                "6": "성검전설3 TRIALS of MANA (한국어판)",
                "7": "0",
                "8": "2020-04-24",
                "9": null,
                "10": null,
                "11": "1",
                "12": "SQUARE ENIX",
                "13": "0",
                "14": "0",
                "15": null,
                "16": null,
                "17": "0",
                "18": "517.jpg",
                "19": "517.jpg",
                "20": "/home/product/admin/private/sw/switch/517/",
                "21": "1",
                "22": "https://store.nintendo.co.kr/kjk1b3lj1ble",
                "23": null,
                "24": null,
                "25": null,
                "26": null,
                "27": null,
                "28": null,
                "29": null,
                "30": null,
                "31": null,
                "32": null,
                "33": null,
                "34": null,
                "35": null,
                "36": null,
                "37": null,
                "38": "0",
                "39": "0",
                "40": "0",
                "41": "2020-03-26 14:48:30",
                "42": null,
                "43": "",
                "44": "aqua8219",
                "45": "OM",
                "46": null,
                "47": null,
                "48": "517",
                "49": "SQUARE ENIX",
                "50": "new",
                "51": "533",
                "52": "1",
                "53": "2020.04.24",
                "54": "Nintendo Switch",
                "55": "0",
                "56": null,
                no: "517",
                sw_gubun: "switch",
                open_schdl: "2020-01-30 17:00:00",
                show_list: "1",
                sw_code: "trialsofmana",
                sw_series: null,
                sw_name: "성검전설3 TRIALS of MANA (한국어판)",
                rls_date_gubun: "0",
                rls_date_cal: "2020-04-24",
                rls_date_sel_y: null,
                rls_date_sel_m: null,
                maker_gubun: "1",
                maker_name: "SQUARE ENIX",
                rls_gubun: "0",
                lang_gubun: "0",
                nrml_price: null,
                rdcd_price: null,
                evnt_list: "0",
                list_bnr_file_name: "517.jpg",
                list_bnr_origin_name: "517.jpg",
                list_bnr_file_path: "/home/product/admin/private/sw/switch/517/",
                link_gubun: "1",
                link: "https://store.nintendo.co.kr/70010000025168",
                sw_contents: null,
                head_copy: null,
                head_copy_color: null,
                bg_color: null,
                etc_color: null,
                btn_color: null,
                btn_txt_color: null,
                main_file_name: null,
                main_origin_name: null,
                main_file_path: null,
                sw_etc_contents: null,
                copyright: null,
                icon_file_name: null,
                icon_origin_name: null,
                icon_file_path: null,
                show_yn: "0",
                accept_yn: "0",
                del_yn: "0",
                reg_date: "2020-03-26 14:48:30",
                sw_genre: null,
                exper_gubun: "",
                auth: "aqua8219",
                rating: "OM",
                attach_text: null,
                search_tag: null,
                maker_gubun_ko: "SQUARE ENIX",
                new: "new",
                list_num: "533",
                dwn_flag: "1",
                rls_date_cal_fmt: "2020.04.24",
                sw_gubun_ko: "Nintendo Switch",
                qr_count: "0",
                detail: null,
              },
            ]),
          });

          await promise;

          checkAndNotify(() => {
            expect(dumpSpy.callCount).to.eq(1);
            expect(dumpSpy.lastCall.lastArg.pop().nsuid).to.eq(70010000025168);
          }, done);
        });
      });

      it("should be null or undefined when theres no way to obtain it", (done) => {
        const dumpSpy = sinon.spy();
        const promise = new KoreaDumper().getFullDump().then(dumpSpy).catch(done);

        moxios.wait(async () => {
          const requestResponse = moxios.requests.mostRecent();
          requestResponse.respondWith({
            headers: {
              "Content-Type": "text/html; charset=UTF-8",
            },
            responseText: JSON.stringify([
              {
                "0": "517",
                "1": "switch",
                "2": "2020-01-30 17:00:00",
                "3": "1",
                "4": "trialsofmana",
                "5": null,
                "6": "성검전설3 TRIALS of MANA (한국어판)",
                "7": "0",
                "8": "2020-04-24",
                "9": null,
                "10": null,
                "11": "1",
                "12": "SQUARE ENIX",
                "13": "0",
                "14": "0",
                "15": null,
                "16": null,
                "17": "0",
                "18": "517.jpg",
                "19": "517.jpg",
                "20": "/home/product/admin/private/sw/switch/517/",
                "21": "1",
                "22": "https://store.nintendo.co.kr/kjk1b3lj1ble",
                "23": null,
                "24": null,
                "25": null,
                "26": null,
                "27": null,
                "28": null,
                "29": null,
                "30": null,
                "31": null,
                "32": null,
                "33": null,
                "34": null,
                "35": null,
                "36": null,
                "37": null,
                "38": "0",
                "39": "0",
                "40": "0",
                "41": "2020-03-26 14:48:30",
                "42": null,
                "43": "",
                "44": "aqua8219",
                "45": "OM",
                "46": null,
                "47": null,
                "48": "517",
                "49": "SQUARE ENIX",
                "50": "new",
                "51": "533",
                "52": "1",
                "53": "2020.04.24",
                "54": "Nintendo Switch",
                "55": "0",
                "56": null,
                no: "517",
                sw_gubun: "switch",
                open_schdl: "2020-01-30 17:00:00",
                show_list: "1",
                sw_code: "trialsofmana",
                sw_series: null,
                sw_name: "성검전설3 TRIALS of MANA (한국어판)",
                rls_date_gubun: "0",
                rls_date_cal: "2020-04-24",
                rls_date_sel_y: null,
                rls_date_sel_m: null,
                maker_gubun: "1",
                maker_name: "SQUARE ENIX",
                rls_gubun: "0",
                lang_gubun: "0",
                nrml_price: null,
                rdcd_price: null,
                evnt_list: "0",
                list_bnr_file_name: "517.jpg",
                list_bnr_origin_name: "517.jpg",
                list_bnr_file_path: "/home/product/admin/private/sw/switch/517/",
                link_gubun: "1",
                link: "https://stqdlkbwlkbwqlbdlqw",
                sw_contents: null,
                head_copy: null,
                head_copy_color: null,
                bg_color: null,
                etc_color: null,
                btn_color: null,
                btn_txt_color: null,
                main_file_name: null,
                main_origin_name: null,
                main_file_path: null,
                sw_etc_contents: null,
                copyright: null,
                icon_file_name: null,
                icon_origin_name: null,
                icon_file_path: null,
                show_yn: "0",
                accept_yn: "0",
                del_yn: "0",
                reg_date: "2020-03-26 14:48:30",
                sw_genre: null,
                exper_gubun: "",
                auth: "aqua8219",
                rating: "OM",
                attach_text: null,
                search_tag: null,
                maker_gubun_ko: "SQUARE ENIX",
                new: "new",
                list_num: "533",
                dwn_flag: "1",
                rls_date_cal_fmt: "2020.04.24",
                sw_gubun_ko: "Nintendo Switch",
                qr_count: "0",
                detail: null,
              },
            ]),
          });

          await promise;

          const data = dumpSpy.lastCall.lastArg;
          checkAndNotify(() => expect(data.pop().nsuid).to.be.eq(null), done);
        });
      });
    });
  });
});
